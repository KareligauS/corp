<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="assets/moment-with-locales.js"></script>
    <script src="assets/jquery-3.7.1.js"></script>
    <script src="scripts/markup_functions.js"></script>
    <link rel="stylesheet" href="styles/index.css">
    <title>Sehriyo Corporate</title>
</head>
<body>
    <div id="styles"></div>
    <header id="header"></header>
    <main id="display"></main>
    <footer id="footer"></footer>

    <script type="text/javascript">
        var origin_url = window.location.origin;
        var website_url = `${window.location.origin}${window.location.pathname}`;
        var data = "";
        var pages = [];
        var components = [];

        var current_components_ids = {
            page: "",
            header: "",
            footer: "",
            display: ""
        }
    
        $(document).ready(function(){
            const setup = async function(){
                pages = [
                    {
                        page_id: "mainpage",
                        header_id: "main-header",
                        display_id: "main-display",
                        footer_id: "main-footer",
                        initialization_function: InitializeMainPage,
                        resetdata_function: ResetMainPageData,
                        animation: "fade",
                        scroll_to_top: true
                    },
                    {
                        page_id: "aboutuspage",
                        header_id: "main-header",
                        display_id: "aboutus-display",
                        footer_id: "main-footer",
                        initialization_function: InitializeMainPage,
                        resetdata_function: ResetMainPageData,
                        animation: "fade",
                        scroll_to_top: true
                    }
                ]

                components = [
                    {
                        id: "main-display",
                        type: "display",
                        html_source: "components/main-display.html",
                        style_source: "styles/main-display.css",
                    },
                    {
                        id: "main-header",
                        type: "header",
                        html_source: "components/main-header.html",
                        style_source: "styles/main-header.css",
                    },
                    {
                        id: "main-footer",
                        type: "footer",
                        html_source: "components/main-footer.html",
                        style_source: "styles/main-footer.css",
                    },
                    {
                        id: "aboutus-display",
                        type: "display",
                        html_source: "components/aboutus-display.html",
                        style_source: "styles/aboutus-display.css",
                    }
                ]

                ChangePage("mainpage");
            }
    
            const loop = function(){
                ResetData();
            }
    
            Main(5000, setup, loop);
        });
    
        async function Main(delay, setup, callback) {
            await setup();
            setInterval(()=> {
                callback();
            }, delay)
        }

        function ResetData(){}

        function InitializeMainPage(){}

        function ResetMainPageData(){}
    
        function BindElements(){
            $(".page-redirect").unbind("click");
            $(".page-redirect").on("click", function(event) {
                let href = $(this).attr('href');
                let pageId = "";

                switch(href){
                    case "#mainpage":
                        pageId = "mainpage";
                        break;
                    case "#aboutuspage":
                        pageId = "aboutuspage";
                        break;
                    default:
                        console.log(`Unexpected pageid_href: ${href}`);
                        break;
                }

                if (pageId != "") {
                    ChangePage(pageId);
                }
            });
        }
    
        function ChangePage(pageId){
            let pageInfo = pages.find((element) => element.page_id == pageId);
            let componentsToLoad = [pageInfo["header_id"], pageInfo["display_id"], pageInfo["footer_id"]];
            let initializationFunction = pageInfo["initialization_function"];
            let resetDataFunction = pageInfo["resetdata_function"];
            let animation = pageInfo["animation"];
            let scrollToTop = pageInfo["scroll_to_top"];
            
            let stylesMarkup = "";
            let callback = function(){
                current_components_ids["page"] = pageId;
                typeof initializationFunction == "function" ? initializationFunction(data) : `Initialization function "${initializationFunction}" wasn't found.`;
                typeof resetDataFunction == "function" ? ResetData = resetDataFunction : `ResetData function "${resetDataFunction}" wasn't found.`;
                BindElements();
                $("#styles").html(stylesMarkup);
            };

            let operation = function(){
                callback();
            }

            componentsToLoad.forEach(componentId => {
                let componentInfo = components.find((element) => element.id == componentId);
                let componentType = componentInfo["type"];
                stylesMarkup += `<link rel="stylesheet" href="${componentInfo["style_source"]}">`;
                if (componentId != current_components_ids[componentType]){
                    let callbackTemp = callback;
                    callback = function(){
                        $(`#${componentType}`).load(componentInfo["html_source"], function(){
                            callbackTemp();
                        });
                    }
                }
                current_components_ids[componentType] = componentId;
            });

            if (scrollToTop){
                $('html, body').animate({ scrollTop: 0 }, 500);
            }

            if (animation == "fade") {
                DisplayFadeAnimation(function(){
                    operation();
                });
            }
            else {
                operation();
            }
        }

        function DisplayFadeAnimation(callback){
            $('#display').fadeOut(400, function(){
                callback();
                $('#display').fadeIn(400);
            });
        }
    </script>
</body>
</html>